---
import dayjs from "dayjs";

const { title, durationLabels, durationConfig = {}, items } = Astro.props;

function calcDuration(startStr: string, endStr?: string) {
  const start = dayjs(startStr);
  const end = endStr ? dayjs(endStr) : dayjs();
  const totalMonths = end.diff(start, "month");
  const years = Math.floor(totalMonths / 12);
  const months = totalMonths % 12;
  const parts: string[] = [];
  if (years > 0) {
    parts.push(`${years} ${years === 1 ? durationLabels.year : durationLabels.years}`);
  }
  if (months > 0) {
    parts.push(`${months} ${months === 1 ? durationLabels.month : durationLabels.months}`);
  }
  if (parts.length === 0) {
    return durationLabels.zero;
  }
  if (parts.length === 1) {
    return parts[0];
  }
  return `${parts[0]} ${durationLabels.and} ${parts[1]}`;
}

const computedDurations = Object.fromEntries(
  Object.entries(durationConfig).map(([key, value]) => [
    key,
    calcDuration(value.start, value.end),
  ]),
);

const applyPlaceholders = (text?: string) => {
  if (!text) return text;
  return Object.entries(computedDurations).reduce(
    (acc, [placeholder, value]) => acc.replaceAll(`{${placeholder}}`, value),
    text,
  );
};
---
<div id="experience" class="mb-5">
  <div class="text-3xl w-full font-bold text-center">{title}</div>
</div>

<div class="mb-10 space-y-3">
  {items.map((item, index) => {
    const subtitle = applyPlaceholders(item.subtitle);
    const compactSubtitle = subtitle?.split(" - ").slice(0, 2).join(" - ");
    const desc = applyPlaceholders(item.desc);

    return (
      <details class="border border-base-300 rounded-lg bg-base-100" open={index === 0}>
        <summary class="px-4 py-3 cursor-pointer list-none">
          <div class="font-semibold">{item.title}</div>
          <div class="text-sm opacity-80">{compactSubtitle}</div>
        </summary>
        <div class="px-4 pb-4 text-sm opacity-90">{subtitle}</div>
        {desc && <p class="px-4 pb-4 whitespace-pre-line">{desc}</p>}
      </details>
    );
  })}
</div>
