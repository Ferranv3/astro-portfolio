---
import TimeItem from "../components/timeItem/TimeItem.astro";
import dayjs from "dayjs";

const { title, durationLabels, durationConfig = {}, items } = Astro.props;

function calcDuration(startStr: string, endStr?: string) {
  const start = dayjs(startStr);
  const end = endStr ? dayjs(endStr) : dayjs();
  const totalMonths = end.diff(start, "month");
  const years = Math.floor(totalMonths / 12);
  const months = totalMonths % 12;
  const parts: string[] = [];
  if (years > 0) {
    parts.push(`${years} ${years === 1 ? durationLabels.year : durationLabels.years}`);
  }
  if (months > 0) {
    parts.push(`${months} ${months === 1 ? durationLabels.month : durationLabels.months}`);
  }
  if (parts.length === 0) {
    return durationLabels.zero;
  }
  if (parts.length === 1) {
    return parts[0];
  }
  return `${parts[0]} ${durationLabels.and} ${parts[1]}`;
}

const computedDurations = Object.fromEntries(
  Object.entries(durationConfig).map(([key, value]) => [
    key,
    calcDuration(value.start, value.end),
  ]),
);

const applyPlaceholders = (text?: string) => {
  if (!text) return text;
  return Object.entries(computedDurations).reduce(
    (acc, [placeholder, value]) => acc.replaceAll(`{${placeholder}}`, value),
    text,
  );
};

function compactDescription(text?: string) {
  if (!text) return text;
  const lines = text
    .split("\n")
    .map((line) => line.trim())
    .filter(Boolean);

  if (lines.length > 0) {
    const firstLine = lines[0];
    return firstLine.length > 140 ? `${firstLine.slice(0, 140).trimEnd()}â€¦` : firstLine;
  }

  const firstSentence = text.split(".")[0]?.trim();
  if (!firstSentence) return text;
  return `${firstSentence}.`;
}
---
<div id="experience" class="mb-5">
  <div class="text-3xl w-full font-bold text-center">{title}</div>
</div>
<div class="time-line-container mb-10">
  {items.map((item, index) => {
    const subtitle = applyPlaceholders(item.subtitle);
    const desc = applyPlaceholders(item.desc);

    return (
      <TimeItem
        title={item.title}
        subtitle={subtitle}
        desc={index === 0 ? desc : compactDescription(desc)}
      />
    );
  })}
</div>
