---
import type { LanguageCode } from "../i18n/translations";
import { supportedLanguages } from "../i18n/translations";

interface Props {
  currentLang: LanguageCode;
  showLabels?: boolean;
}

const { currentLang, showLabels = false } = Astro.props as Props;

const flagSvgs: Record<LanguageCode, string> = {
  en: `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 24" width="36" height="24">
  <rect width="36" height="24" fill="#012169" />
  <path fill="#ffffff" d="M0 0l14 9V0h8v9L36 0v5L22 12l14 7v5l-14-9v9h-8v-9L0 24v-5l14-7L0 5z" />
  <path fill="#c8102e" d="M0 0l15 9.5V0h6v9.5L36 0v4L21 12l15 8v4l-15-9.5V24h-6v-9.5L0 24v-4l15-8L0 4z" />
  <path fill="#ffffff" d="M13 0h10v24H13z" />
  <path fill="#ffffff" d="M0 7h36v10H0z" />
  <path fill="#c8102e" d="M14.5 0h7v24h-7z" />
  <path fill="#c8102e" d="M0 8.5h36v7H0z" />
</svg>
`.trim(),
  es: `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 24" width="36" height="24">
  <rect width="36" height="24" fill="#aa151b" />
  <rect y="6" width="36" height="12" fill="#f1bf00" />
</svg>
`.trim(),
  ca: `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 24" width="36" height="24">
  <rect width="36" height="24" fill="#f1bf00" />
  <rect y="0" width="36" height="3" fill="#c8102e" />
  <rect y="6" width="36" height="3" fill="#c8102e" />
  <rect y="12" width="36" height="3" fill="#c8102e" />
  <rect y="18" width="36" height="3" fill="#c8102e" />
</svg>
`.trim(),
};

const languageMeta: Record<LanguageCode, { flagSvg?: string; label: string }> = {
  en: { flagSvg: flagSvgs.en, label: "English" },
  es: { flagSvg: flagSvgs.es, label: "Español" },
  ca: { flagSvg: flagSvgs.ca, label: "Català" },
};

const { pathname, search, hash } = Astro.url;
const segments = pathname.split("/").filter(Boolean);
const isLangPrefixed = supportedLanguages.includes(segments[0] as LanguageCode);
const hasTrailingSlash = pathname.endsWith("/") && pathname !== "/";

const buildHref = (lang: LanguageCode) => {
  let newSegments = [...segments];
  if (isLangPrefixed) {
    newSegments[0] = lang;
  } else {
    newSegments = [lang, ...newSegments];
  }

  let path = `/${newSegments.join("/")}`;
  if (path !== "/" && hasTrailingSlash) {
    path = `${path.replace(/\/$/, "")}/`;
  }

  return `${path}${search}${hash}`;
};

const options = supportedLanguages.map((code) => {
  const meta = languageMeta[code];
  return {
    code,
    flagSvg: meta?.flagSvg,
    fallback: code.toUpperCase(),
    label: meta?.label ?? code.toUpperCase(),
    href: buildHref(code),
  };
});

const current = options.find((opt) => opt.code === currentLang) ?? options[0];
---
<div class="dropdown dropdown-end">
  <button
    type="button"
    class:list={{
      "btn btn-ghost gap-2": showLabels,
      "btn btn-ghost btn-square": !showLabels,
    }}
    tabindex="0"
    aria-label={`Change language, current ${current.label}`}
  >
    {current.flagSvg ? (
      <span class="flag-icon" aria-hidden="true" set:html={current.flagSvg}></span>
    ) : (
      <span class="flag-icon-text" aria-hidden="true">{current.fallback}</span>
    )}
    {showLabels && <span class="font-medium">{current.label}</span>}
    <svg
      class:list={{ "w-3 h-3 opacity-70": true, hidden: !showLabels }}
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke-width="1.5"
      stroke="currentColor"
      aria-hidden="true"
    >
      <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
    </svg>
  </button>
  <ul
    tabindex="0"
    class:list={{
      "mt-3 p-2 shadow menu menu-sm dropdown-content bg-base-200 rounded-box": true,
      "w-36": showLabels,
      "w-20": !showLabels,
    }}
  >
    {options.map((option) => (
      <li>
        <a
          class:list={{
            active: option.code === current.code,
            "pointer-events-none": option.code === current.code,
            "flex gap-2 items-center": showLabels,
            "justify-center": !showLabels,
          }}
          href={option.href}
          lang={option.code}
          aria-current={option.code === current.code ? "true" : "false"}
        >
          {option.flagSvg ? (
            <span class="flag-icon" aria-hidden="true" set:html={option.flagSvg}></span>
          ) : (
            <span class="flag-icon-text" aria-hidden="true">{option.fallback}</span>
          )}
          {showLabels && <span>{option.label}</span>}
        </a>
      </li>
    ))}
  </ul>
</div>

<style>
  .flag-icon {
    display: inline-flex;
    width: 1.75rem;
    height: auto;
  }

  .flag-icon svg {
    display: block;
    width: 100%;
    height: auto;
    border-radius: 0.25rem;
    overflow: hidden;
  }

  .flag-icon-text {
    font-size: 0.9rem;
    font-weight: 600;
  }
</style>
