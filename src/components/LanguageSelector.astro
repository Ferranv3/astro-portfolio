---
import type { LanguageCode } from "../i18n/translations";
import { supportedLanguages } from "../i18n/translations";

interface Props {
  currentLang: LanguageCode;
  showLabels?: boolean;
}

const { currentLang, showLabels = false } = Astro.props as Props;

const languageMeta: Record<LanguageCode, { flag: string; label: string }> = {
  en: { flag: "ðŸ‡ºðŸ‡¸", label: "English" },
  es: { flag: "ðŸ‡ªðŸ‡¸", label: "EspaÃ±ol" },
};

const { pathname, search, hash } = Astro.url;
const segments = pathname.split("/").filter(Boolean);
const isLangPrefixed = supportedLanguages.includes(segments[0] as LanguageCode);
const hasTrailingSlash = pathname.endsWith("/") && pathname !== "/";

const buildHref = (lang: LanguageCode) => {
  let newSegments = [...segments];
  if (isLangPrefixed) {
    newSegments[0] = lang;
  } else {
    newSegments = [lang, ...newSegments];
  }

  let path = `/${newSegments.join("/")}`;
  if (path !== "/" && hasTrailingSlash) {
    path = `${path.replace(/\/$/, "")}/`;
  }

  return `${path}${search}${hash}`;
};

const options = supportedLanguages.map((code) => {
  const meta = languageMeta[code];
  return {
    code,
    flag: meta?.flag ?? code.toUpperCase(),
    label: meta?.label ?? code.toUpperCase(),
    href: buildHref(code),
  };
});

const current = options.find((opt) => opt.code === currentLang) ?? options[0];
---
<div class="dropdown dropdown-end">
  <button
    type="button"
    class:list={{
      "btn btn-ghost gap-2": showLabels,
      "btn btn-ghost btn-square": !showLabels,
    }}
    tabindex="0"
    aria-label={`Change language, current ${current.label}`}
  >
    <span class="text-xl leading-none" aria-hidden="true">{current.flag}</span>
    {showLabels && <span class="font-medium">{current.label}</span>}
    <svg
      class:list={{ "w-3 h-3 opacity-70": true, hidden: !showLabels }}
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke-width="1.5"
      stroke="currentColor"
      aria-hidden="true"
    >
      <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
    </svg>
  </button>
  <ul
    tabindex="0"
    class:list={{
      "mt-3 p-2 shadow menu menu-sm dropdown-content bg-base-200 rounded-box": true,
      "w-36": showLabels,
      "w-20": !showLabels,
    }}
  >
    {options.map((option) => (
      <li>
        <a
          class:list={{
            active: option.code === current.code,
            "pointer-events-none": option.code === current.code,
            "flex gap-2 items-center": showLabels,
            "justify-center": !showLabels,
          }}
          href={option.href}
          lang={option.code}
          aria-current={option.code === current.code ? "true" : "false"}
        >
          <span class="text-lg" aria-hidden="true">{option.flag}</span>
          {showLabels && <span>{option.label}</span>}
        </a>
      </li>
    ))}
  </ul>
</div>
